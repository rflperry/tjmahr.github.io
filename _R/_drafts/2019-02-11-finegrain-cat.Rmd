---
title: Draft post (2019-02-11)
excerpt: ''
tags: ''
header:
  overlay_image: "assets/images/marisa-morton-1280.jpg"
  image_description: "A wall of donuts"
  overlay_filter: rgba(10, 10, 10, 0.1)
  caption: "Photo credit: [**Yuval Levy**](https://unsplash.com/photos/r3VbEP24__o)"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In this post, I walk through the code I used to make a nice diagram illustrating
the parameters in a logistic growth curve. I made this figure for a conference
submission. I had a tight word limit (600 words) and a complicated
statistical method (Bayesian nonlinear mixed effects beta regression), so I
wanted to use a diagram to handle some of the explanatory burden. Also, figures
didn't count towards the word limit, so that was a bonus.

In Septemer, I started a job as a data scientist for an NIH project studying how
speech, language and communication development in children with cerebral palsy.
My title says assistant scientist, but I call myself a data scientist because I
still do all my work in RStudio and because it makes feel cool. And I study
development

## Growth towards a ceiling

Children can be hard to understand; they are learning to talk after all. You
probably can imagine a four-year old asking politely asking for something:
"pwetty pwease". This understandability problem is compounded for children with
cerebral palsy, because these kids will often have speech-motor impairments on
top of the usual developmental patterns. My current project is a statistical
model of how *intelligibility*---the probability that an unfamiliar listener
understands what a child says---develops from age 3 to age 8. 

For example, here are some data. Most of the code here is for formating the
axes.

```{r}
library(tidyverse)
points <- tibble(
  age = c(30, 37, 44, 53, 72, 66) + 8, 
  prop = c(0.146, 0.241, 0.571, 0.745, 0.843, 0.738))

ggplot(points) + 
  aes(x = age, y = prop) + 
  geom_point() +
  scale_x_continuous(
    name = "Age in months", 
    limits = c(0, 96), 
    # Break the x-axis up on 12 months
    breaks = scales::extended_breaks(Q = c(24, 12))) + 
  scale_y_continuous(
    name = "Intelligibility",
    limits = c(0, NA),
    labels = scales::percent_format(accuracy = 1))
```


One of the interesting features of speech development is that it finishes:
Children stop making their usual developmental speech patterns and converge on a
mature level of performance. They stop making the stereotypical patterns of
child speech.

For the statistical models, we expected children to follow a certain
developmental trajectory towards this ceiling: Begin at zero intelligibility,
show a period of accelerating then decelerating growth, and finally plateau at
some mature level of ability. This pattern of growth can be modeled using a
logistic growth curve using three parameters: an asymptote, a midpoint when
growth is steepest, and a scale which sets the slope of the curve.

Below is the equation of the logistic growth curve:

$$f(t) = \frac{\text{asymptote}}{1 + \exp{((\text{mid}~-~t)~*~\text{scale})}}$$

But this equation doesn't do us any good. If you are like me, you probably
stopped paying attention when you saw exp() in the denominator.




```{r}

xs <- seq(0, 96, length.out = 80)

# crossing(
#   xs = xs,
#   asymptote = c(.4, .6, .8),
#   scale = c(-0.05, .1, .2, .3),
#   midpoint = c(40)
#   
#   ) %>% 
#   mutate(
#     ys = asymptote / (1 + exp((midpoint - xs) * scale))) %>% 
#   ggplot() + 
#   aes(x = xs, y = ys, group = interaction(asymptote, midpoint, scale)) + 
#   geom_line(aes(color = factor(scale)))

trend <- tibble(
  xs = xs,
  asymptote = .8,
  scale = .2,
  midpoint = 48,
  ys = asymptote / (1 + exp((midpoint - xs) * scale)))

ggplot(points) + 
  aes(x = age, y = prop) + 
  geom_point() +
  geom_line(aes(x = xs, y = ys), data = trend) +
  scale_x_continuous(
    name = "Age in months", 
    limits = c(0, 96), 
    breaks = scales::extended_breaks(Q = c(24, 12))) + 
  scale_y_continuous(
    name = "Intelligibility",
    limits = c(0, NA),
    labels = scales::percent_format(accuracy = 1))
```



```{r}

blood_orange <- "#E7552C"
# col_black <- "#2F2E33"
col_black <- "#414145"
col_asym <- "#E7552C"
col_mid <- "#3B7B9E"
col_scale <- "#1FA35C"

# Compute endpoints for segment for slope in middle
slope <- (.2 / 4) * .8
y1 <- .4 + slope * -3
y2 <- .4 + slope * 3

ggplot(trend) +
  aes(x = xs, y = ys) +
  geom_segment(
    color = col_mid,
    x = 48,
    xend = 48,
    y = 0,
    yend = .4,
    linetype = "dashed") +
  geom_segment(
    color = col_asym,
    x = 48 - 2,
    xend = Inf,
    y = .8,
    yend = .8,
    linetype = "dashed") +
  geom_line(
    # the actual curve
    aes(group = scale),
    size = 1,
    color = col_black) +
  geom_point(
    aes(x = age, y = prop), 
    data = points, size = 3, shape = 1) +
  geom_segment(
    color = col_scale,
    arrow = arrow(ends = "both", length = unit(.1, "in")),
    size = 1.2,
    x = 48 - 3,
    xend = 48 + 3,
    y = y1,
    yend = y2) +
  annotate(
    "text",
    label = "growth plateaus at asymptote",
    y = .84,
    x = 49,
    hjust = 0,
    color = col_asym) +
  annotate(
    "text",
    label = "growth steepest at midpoint",
    y = .05,
    x = 49,
    hjust = 0,
    color = col_mid) +
  annotate(
    "text",
    label = "scale controls slope of curve",
    y = .36,
    x = 49,
    hjust = 0,
    color = col_scale) +
  scale_x_continuous(breaks = scales::extended_breaks(Q = c(12, 6))) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  theme_minimal() +
  labs(
    x = "Age in months",
    y = "Estimated intelligibility"
    # title = "Anatomy of logistic growth curve"
    )


```


This curve is flexible enough to capture many patterns—for example, sudden
growth (sharp slope), delay (later midpoint), or no change at all (low
asymptote)—so these parameters provide a way to estimate individual differences
in developmental trajectories.


```{r, eval = FALSE, echo = FALSE}
library(tidyverse)
library(rstan)
library(brms)
library(tidybayes)

# The next few lines just follow advice from RStan

options(mc.cores = 4)
rstan_options(auto_write = TRUE)
Sys.setenv(LOCAL_CPPFLAGS = '-march=native')

f0 <- bf(
  prop ~ asym * inv(1 + exp((mid - age) * scale)),
  asym ~ 1,
  mid ~ 1,
  scale ~ 1,
  nl = TRUE)

prior_fixef <- c(
  prior(beta(8, 2), nlpar = "asym", coef = "Intercept"),
  prior(normal(50, 6), nlpar = "mid", coef = "Intercept"),
  prior(normal(2, .5), nlpar = "scale", coef = "Intercept")
)

plogis(rnorm(1000, 1, .5))
mean(plogis(rnorm(1000, 1, .5)))
plot(density(rbeta(1000, 8, 2)))
beta()

# prior_phi <- c(
#   prior(normal(2, 1), dpar = "phi", class = "Intercept")
# )

fit_beta <- brm(
  f0,
  data = points,
  prior = c(prior_fixef),
  family = Beta(link = identity),
  iter = 2000,
  chains = 4,
  control = list(adapt_delta = 0.90, max_treedepth = 15))
fit_beta


fit_draw <- fit_beta


points %>%
  tidyr::expand(
    age = seq(0, 96, length.out = 80)) %>%
  tidybayes::add_fitted_draws(
    fit_draw,
    n = 1000) %>%
  ggplot() +
    aes(x = age, y = .value) +
    stat_summary(fun.data = median_hdci) +
    geom_point(aes(y = prop), data = points) 

points %>%
  tidyr::expand(
    age = seq(0, 96, length.out = 80)) %>%
  tidybayes::add_fitted_draws(
    fit_draw,
    n = 40) %>%
  ggplot() +
    aes(x = age, y = .value) +
    geom_line(aes(group = .draw), alpha = .1) +
      # stat_summary(fun.data = median_hdci) +
    geom_point(aes(y = prop), data = points) 

intels <- d %>%
  distinct(age, sid, intel2)

summary <- d %>%
  tidyr::expand(
    age = seq(24, max(age), by = 1),
    nesting(slpg, sid)) %>%
  tidybayes::add_fitted_draws(fit_draw, n = 1000) %>%
  ungroup()


```



