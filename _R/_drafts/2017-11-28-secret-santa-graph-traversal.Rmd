---
title: Draft post (2017-11-28)
excerpt: ''
tags: ''
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Last week at Thanksgiving, my family drew names from a hat for our annual game of Secret Santa. In our family, the rules of Secret Santa are pretty simple:

* The players' names are put in a hat. 
* Players randomly draw a name from a hat, become that person's Secret Santa,
  and get them a gift.
* If a player draws their own name, they draw again.

Once again this year, somebody asked if we could just use an app or a website to
handle the drawing for Secret Santa. _Or I could write a script to do it_ I
thought. But the problem in our household is a litte more nuanced than that.

In this post, I describe Secret Santa sampling algorithms using R and directed graphs.

If you would like a more practical way to use R for Secret Santa, including
automating the process of drawing names and _emailing players_, see this post.

```{r}
library(DiagrammeR)
library(magrittr)

people <- c("Jeremy" = 1, "TJ" = 2, "Jonathan" = 3, "Alex" = 4, "Marissa" = 5)
partners <- c("Andrea" = 6, "Amanda" = 7, "Justin" = 8, "Sara" = 9, "Paul" = 10)

couples <- combine_edfs(
  create_edge_df(from = people, to = partners, rel = "spouse", color = "green"),
  create_edge_df(from = partners, to = people, rel = "spouse", color = "green")
)

everyone <- c(people, partners)

nodes <- create_node_df(
  n = length(everyone),
  type = names(everyone),
  label = names(everyone))

create_secret_santa_edges <- function(xs, ...) {
  pairs <- combn(seq_along(xs), 2)
  from <- c(pairs[1, ], pairs[2, ])
  to <- c(pairs[2, ], pairs[1, ])

  create_edge_df(from = from, to = to, ...)
}

create_hamiltonian_secret_santa_edges <- function(xs, ...) {
  loop_from <- sample(seq_along(xs))
  loop_to <- c(loop_from[-1], loop_from[1])

  create_edge_df(from = loop_from, to = loop_to, ...)
}

overwrite_edges <- function(old_df, new_df) {
  old_df %>%
    anti_join(new_df, by = c("from", "to")) %>%
    bind_rows(new_df)
}

draw_secret_santa_edge <- function(edge_df, ...) {
  # edge_df %>% count(from)
  # edge_df %>% count(from)
  edge_df %>%
    filter(rel != "ss") %>%
    sample_n(1) %>%
    mutate(!!! quos(...))
}



edges <- create_secret_santa_edges(
  xs = people,
  rel = "potential secret santa",
  color = "grey90")

edges <- create_secret_santa_edges(
  xs = everyone,
  rel = "potential secret santa",
  color = "grey90")

edges %>%
  overwrite_edges(couples) %>%
  create_graph(nodes, .) %>%
  render_graph(layout = "circle")


ss_edges <- create_hamiltonian_secret_santa_edges(
  people,
  color = "red",
  rel = "secret santa")


edges %>%
  overwrite_edges(ss_edges) %>%
  create_graph(nodes_df = nodes, edges = .) %>%
  render_graph()


g <- create_graph(nodes, edges)
render_graph(g)

pick1 <- draw_secret_santa_edge(edges, color = "pink", rel = "ss")

e1 <- edges %>%
  overwrite_edges(pick1) %>%
  shake_edge(pick1)

pick2 <- draw_secret_santa_edge(e1, color = "pink", rel = "ss")

e2 <- e1 %>%
  overwrite_edges(pick2) %>%
  shake_edge(pick2)



e1 %>%
  create_graph(nodes_df = nodes, edges = .) %>%
  render_graph(layout = "circle")

e2 %>%
  create_graph(nodes_df = nodes, edges = .) %>%
  render_graph(layout = "circle")
all(edges$rel != "ss")

while (any(edges$rel != "ss")) {
  pick1 <- draw_secret_santa_edge(edges, color = "pink", rel = "ss")
  edges <- edges %>%
    overwrite_edges(pick1) %>%
    shake_edge(pick1)
}

edges %>%
  create_graph(nodes_df = nodes, edges = .) %>%
  render_graph(layout = "circle")



e2

shake_edge <- function(edge_df, edge, ...) {
  outgoing_to_drop <- edge_df %>%
    filter(.data$from %in% edge$from)

  incoming_to_drop <- edge_df %>%
    filter(.data$to %in% edge$to)

  to_keep <- intersect(outgoing_to_drop, incoming_to_drop)

  edge_df %>%
    anti_join(outgoing_to_drop, by = c("id")) %>%
    anti_join(incoming_to_drop, by = c("id")) %>%
    bind_rows(to_keep)
}



edges %>%
  overwrite_edges(ss_edges) %>%
  create_graph(nodes_df = nodes, edges = .) %>%
  render_graph()





combin
# Create a simple EDF

library(dplyr)


edges <- edges %>%
  dplyr::anti_join(edges2 %>% select(-id, -rel, -color)) %>%
  bind_rows(edges2)
g <- create_graph(nodes_df = nodes, edges = edges)
render_graph(g)





g <- create_graph(nodes_df = nodes, edges = edges)
render_graph(g)


g %>%
  select_edges_by_edge_id(shake_edge(edges, from = 1, to = 3) %>% pull(id)) %>%
  delete_edges_ws() %>%
  render_graph()

edges %>%
  shake_edge(edges, from = 1, to = 3) %>%

  create_graph(nodes_df = nodes, edges = edges)

g %>% delete_edge(from = edges$from)
add_edge_df() %>% render_graph()




ndf <-
  create_node_df(
    n = 4,
    type = "basic",
    label = TRUE,
    value = c(3.5, 2.6, 9.4, 2.7))

edf <-
  create_edge_df(
    from = c(1, 2, 3),
    to = c(4, 3, 1),
    rel = "leading_to")

graph <-
  create_graph(
    nodes_df = ndf,
    edges_df = edf)

render_graph(graph)

# Set attribute `color = "green"`
# for edges `1`->`4` and `3`->`1`
# using the graph object
graph <-
  set_edge_attrs(
    x = graph,
    edge_attr = color,
    values = "green",
    from = c(1, 3),
    to = c(4, 1))

render_graph(graph)

# Set attribute `color = "green"`
# for edges `1`->`4` and `3`->`1`
# using the edge data frame
edges <-
  set_edge_attrs(
    x = edf,
    edge_attr = color,
    values = "green",
    from = c(1, 3),
    to = c(4, 1))

# Set attribute `color = "blue"`
# for all edges in the graph
graph <-
  set_edge_attrs(
    x = graph,
    edge_attr = color,
    values = "blue")
render_graph(graph)

# Set attribute `color = "pink"`
# for all edges in graph outbound
# from node with ID value `1`
graph <-
  set_edge_attrs(
    x = graph,
    edge_attr = color,
    values = "pink",
    from = 1)
render_graph(graph)

# Set attribute `color = "black"`
# for all edges in graph inbound
# to node with ID `1`
graph <-
  set_edge_attrs(
    x = graph,
    edge_attr = color,
    values = "black",
    to = 1)
render_graph(graph)



# Create three graphs
graph_1 <-
  create_graph() %>%
  add_n_nodes(n = 3) %>%
  add_edges_w_string(
    edges = "1->3 1->2 2->3")

graph_2 <-
  graph_1 %>%
  delete_edge(
    from = 1,
    to = 2)

# Create an empty graph series and add
# the graphs
series <-
  create_series() %>%
  add_to_series(graph_1, .) %>%
  add_to_series(graph_2, .)

# Count the number of graphs in the graph series
graph_count(series)
#> [1] 3
render_graph_from_series(series, 1)
render_graph_from_series(series, 2)

```

